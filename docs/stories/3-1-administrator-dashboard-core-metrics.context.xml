<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>3</epicId>
    <storyId>1</storyId>
    <title>Administrator Dashboard - Core Metrics</title>
    <status>drafted</status>
    <generatedAt>2025-11-04</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/3-1-administrator-dashboard-core-metrics.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>administrator</asA>
    <iWant>view real-time program metrics on my dashboard</iWant>
    <soThat>I can monitor program health and make informed decisions</soThat>
    <tasks>
      - Task 1: Create dashboard app structure and routing (AC: 1)
      - Task 2: Implement metrics aggregation service (AC: 1, 3, 4)
      - Task 3: Implement visitor analytics tracking (AC: 2)
      - Task 4: Create admin dashboard template (AC: 1, 2, 5, 6)
      - Task 5: Implement real-time metric updates (AC: 3)
      - Task 6: Implement CSV export functionality (AC: 7)
      - Task 7: Performance optimization and caching (AC: 4)
      - Task 8: Write comprehensive tests
    </tasks>
  </story>

  <acceptanceCriteria>
    1. Administrator dashboard displays key metrics: total schools, instructors, students, active spaces
    2. Visitor analytics show daily, weekly, and monthly visitor counts
    3. Metrics update in real-time (no manual refresh required)
    4. Dashboard loads in under 3 seconds
    5. Responsive design works on desktop and tablet
    6. Charts/visualizations use accessible color schemes
    7. Export functionality allows downloading metrics as CSV
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/PRD.md" title="Product Requirements Document">
        <section name="Functional Requirements">
          - FR014: System shall provide administrators with real-time metrics including total schools, instructors, students, active spaces, and visitor counts (daily/weekly/monthly)
          - FR015: System shall display instructor-level operational status and activity summaries
        </section>
        <section name="Non-Functional Requirements">
          - NFR001: System shall support 500 concurrent users with page load times under 3 seconds
        </section>
        <section name="UX Design Principles">
          Simplicity First, Clarity and Transparency, Error Recovery, WCAG 2.1 AA accessibility compliance for all user-facing interfaces
        </section>
      </doc>

      <doc path="docs/architecture.md" title="Decision Architecture">
        <section name="Dashboard Metrics Flow">
          Admin accesses dashboard → dashboard/metrics.py aggregates data from School, User, Student models → Rendered in admin_dashboard.html
        </section>
        <section name="Performance Considerations">
          - Template caching for dashboard metrics (5 minutes using Django cache framework)
          - Database query optimization with select_related() and prefetch_related()
          - Indexes on foreign keys and frequently queried fields
        </section>
        <section name="Technology Stack">
          - Django 4.2 LTS with Django Templates
          - Tailwind CSS for frontend styling
          - MySQL 8.0 database
          - Database sessions (no Redis)
        </section>
      </doc>

      <doc path="docs/epics.md" title="Epic Breakdown">
        <section name="Story 3.1: Administrator Dashboard - Core Metrics">
          All 7 acceptance criteria listed with prerequisite stories: 1-3 (Role-Based Access Control), 2-2 (School and Class Data Models)
        </section>
        <section name="Epic 3: Dashboard & Monitoring">
          Epic Goal: Provide administrators with real-time visibility into program operations and enable instructors to manage spaces while offering public visibility into student achievements.
        </section>
      </doc>
    </docs>

    <code>
      <artifact path="authentication/mixins.py" kind="middleware/mixin" symbol="AdminRequiredMixin">
        <lines>Full file</lines>
        <reason>Access control decorator for admin-only views - must be used for dashboard view</reason>
      </artifact>

      <artifact path="authentication/models.py" kind="model" symbol="User">
        <lines>Full file</lines>
        <reason>Custom User model with role field - needed for filtering instructors (User.objects.filter(role='instructor'))</reason>
      </artifact>

      <artifact path="students/models.py" kind="model" symbol="School, Student, Class">
        <lines>Full file</lines>
        <reason>Core data models for metrics aggregation - School.objects.count(), Student.objects.count(), Student.objects.exclude(zep_space_url='')</reason>
      </artifact>

      <artifact path="students/services.py" kind="service" symbol="export_credentials_csv">
        <lines>221-252</lines>
        <reason>CSV export pattern with UTF-8 BOM - reuse pattern for metrics export</reason>
      </artifact>

      <artifact path="templates/dashboard" kind="templates" symbol="(directory)">
        <lines>N/A</lines>
        <reason>Template directory exists - create admin_dashboard.html here with Tailwind CSS</reason>
      </artifact>

      <artifact path="authentication/tests.py" kind="test" symbol="AdminRequiredTestCase">
        <lines>Full file</lines>
        <reason>Testing pattern for @admin_required access control - follow same pattern for dashboard tests</reason>
      </artifact>

      <artifact path="students/test_csv_upload.py" kind="test" symbol="(test patterns)">
        <lines>Full file</lines>
        <reason>Comprehensive test patterns using Django TestCase - follow similar structure for dashboard tests</reason>
      </artifact>
    </code>

    <dependencies>
      <python>
        <package name="Django" version="4.2.16">Core framework</package>
        <package name="mysqlclient" version=">=2.2.0">Database driver</package>
        <package name="pandas" version=">=2.0.0">Data processing (for CSV export)</package>
        <package name="requests" version=">=2.31.0">HTTP requests (if ZEP API integration needed)</package>
        <package name="python-decouple" version=">=3.8">Environment variables</package>
        <package name="pytest-django" version=">=4.5.2">Testing framework</package>
        <package name="coverage" version=">=7.0.0">Test coverage</package>
      </python>

      <frontend>
        <framework name="Tailwind CSS">Server-side rendered templates with utility-first CSS</framework>
        <library name="Chart.js" optional="true">Optional for visualizations (or use server-side rendered bars)</library>
      </frontend>
    </dependencies>
  </artifacts>

  <constraints>
    - MUST use @admin_required decorator (from authentication/mixins.py) for dashboard view access control
    - MUST create dashboard app if not exists (should exist from Story 1.1)
    - MUST use Django ORM with select_related()/prefetch_related() for query optimization
    - MUST implement 5-minute caching using Django cache framework (cache.get/cache.set)
    - MUST achieve page load time < 3 seconds (NFR001)
    - MUST use Tailwind CSS for styling (consistent with existing templates)
    - MUST ensure WCAG 2.1 AA accessibility (color contrast, keyboard navigation)
    - MUST use UTF-8 BOM for CSV export (Excel compatibility)
    - MUST use Django Templates (server-side rendering, no SPA)
    - DO NOT create new authentication/permission system - reuse existing @admin_required
    - DO NOT recreate CSV export logic - follow pattern from students/services.py:export_credentials_csv()
  </constraints>

  <interfaces>
    <interface name="DashboardMetrics Service" kind="service-class">
      <signature>
class DashboardMetrics:
    CACHE_KEY = 'admin_dashboard_metrics'
    CACHE_TIMEOUT = 300  # 5 minutes

    @staticmethod
    def get_core_metrics() -> dict:
        """Returns: {'total_schools': int, 'total_instructors': int, 'total_students': int, 'active_spaces': int, 'visitor_stats': dict, 'timestamp': str}"""
        pass

    @staticmethod
    def get_visitor_stats() -> dict:
        """Returns: {'daily': int, 'weekly': int, 'monthly': int}"""
        pass
      </signature>
      <path>dashboard/metrics.py (NEW)</path>
    </interface>

    <interface name="Admin Dashboard View" kind="django-view">
      <signature>
@admin_required
def admin_dashboard(request):
    """Main admin dashboard view"""
    metrics = DashboardMetrics.get_core_metrics()
    return render(request, 'dashboard/admin_dashboard.html', {'metrics': metrics})
      </signature>
      <path>dashboard/views.py (NEW)</path>
    </interface>

    <interface name="Metrics API Endpoint" kind="rest-endpoint">
      <signature>
GET /dashboard/api/metrics/
Response: JSON with current metrics (for AJAX polling)
{
  "total_schools": int,
  "total_instructors": int,
  "total_students": int,
  "active_spaces": int,
  "visitor_stats": {"daily": int, "weekly": int, "monthly": int},
  "timestamp": "ISO 8601"
}
      </signature>
      <path>dashboard/views.py (NEW - metrics_api view)</path>
    </interface>

    <interface name="CSV Export Endpoint" kind="django-view">
      <signature>
@admin_required
def export_metrics(request):
    """Export dashboard metrics as CSV"""
    metrics = DashboardMetrics.get_core_metrics()
    return export_metrics_csv(metrics)
      </signature>
      <path>dashboard/views.py (NEW)</path>
    </interface>

    <interface name="Visitor Tracking Middleware" kind="middleware">
      <signature>
class VisitorTrackingMiddleware:
    def __init__(self, get_response):
        self.get_response = get_response

    def __call__(self, request):
        # Track only public landing page visits (path == '/')
        if request.path == '/' and request.method == 'GET':
            VisitorLog.objects.create(...)
        return self.get_response(request)
      </signature>
      <path>dashboard/middleware.py (NEW)</path>
    </interface>

    <interface name="VisitorLog Model" kind="django-model">
      <signature>
class VisitorLog(models.Model):
    timestamp = models.DateTimeField(auto_now_add=True, db_index=True)
    ip_address = models.GenericIPAddressField()
    user_agent = models.TextField()
    path = models.CharField(max_length=255)
      </signature>
      <path>dashboard/models.py (NEW)</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Use Django TestCase framework (not pytest for this story). Follow patterns from authentication/tests.py and students/test_csv_upload.py.
      Create test fixtures in setUp() method. Test both functionality and performance requirements.
      Use Django test client for view testing. Create test file: dashboard/test_admin_dashboard.py
    </standards>

    <locations>
      - dashboard/test_admin_dashboard.py (NEW - primary test file for Story 3.1)
      - dashboard/tests.py (MODIFY - add model tests for VisitorLog)
    </locations>

    <ideas>
      - AC1: Test metrics calculation returns correct counts (schools, instructors, students, active spaces)
      - AC2: Test visitor analytics aggregation (daily, weekly, monthly counts)
      - AC3: Test AJAX polling endpoint returns valid JSON with current metrics
      - AC4: Test dashboard load time < 3 seconds with 1000+ records
      - AC5: Test responsive design rendering on desktop and tablet viewports
      - AC6: Test color contrast meets WCAG 2.1 AA (use automated tool or manual check)
      - AC7: Test CSV export produces valid UTF-8 file with BOM and correct data
      - Test @admin_required decorator prevents non-admin access (403 Forbidden)
      - Test visitor tracking middleware logs visits correctly
      - Test caching: second request uses cached metrics (5-minute TTL)
      - Test real-time updates: AJAX call refreshes metrics without page reload
    </ideas>
  </tests>
</story-context>
